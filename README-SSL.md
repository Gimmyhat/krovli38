# Управление SSL сертификатами в проекте Krovli38

## Автоматический процесс через CI/CD

Проект настроен на автоматическое получение и обновление SSL-сертификатов через Let's Encrypt. Весь процесс интегрирован в CI/CD пайплайн и выполняется автоматически.

### Как это работает:

1. **При первоначальном деплое:**
   - Создается временный самоподписанный сертификат
   - Nginx настраивается для работы в HTTP режиме
   - Запускается процесс получения сертификата Let's Encrypt
   - После получения сертификата, Nginx автоматически перенастраивается на HTTPS

2. **Автоматическое обновление:**
   - Сервис certbot проверяет срок действия сертификатов каждые 12 часов
   - Если сертификаты истекают менее чем через 30 дней, они автоматически обновляются
   - Дополнительно, каждый месяц запускается GitHub Actions job для принудительной проверки

3. **Особенности конфигурации:**
   - Health check endpoint всегда доступен через HTTP для мониторинга
   - Nginx автоматически определяет наличие сертификатов и работает соответственно
   - Если сертификаты отсутствуют, все сервисы временно доступны по HTTP
   - Если сертификаты присутствуют, активируется принудительное перенаправление на HTTPS

## DNS-запись для автоверификации

При запросе или обновлении сертификатов через DNS-01 challenge, необходимо обновить TXT-запись:

1. Имя: `_acme-challenge.www.krovlya38.pro.` (обратите внимание на точку в конце)
2. Тип: TXT
3. Значение: будет сгенерировано автоматически

## Ручное управление сертификатами (при необходимости)

В случае необходимости ручного управления, используйте следующие команды на сервере:

```bash
# Запуск процесса получения сертификатов
cd /root/krovli38
chmod +x init-letsencrypt.sh
./init-letsencrypt.sh

# Принудительное обновление сертификатов
docker compose run --rm certbot certbot renew --force-renewal
docker compose exec nginx nginx -s reload

# Проверка статуса сертификатов
docker compose run --rm certbot certbot certificates
```

## Устранение неполадок

Если возникают проблемы с SSL:

1. Проверьте логи:
   ```bash
   docker compose logs certbot
   docker compose logs nginx
   ```

2. Проверьте наличие файлов сертификатов:
   ```bash
   ls -la /root/krovli38/certbot/conf/live/krovlya38.pro/
   ```

3. Убедитесь, что certbot имеет права на доступ к директориям:
   ```bash
   chmod -R 755 /root/krovli38/certbot/conf
   chmod -R 755 /root/krovli38/certbot/www
   ```

4. Проверьте корректность DNS-записей:
   ```bash
   dig TXT _acme-challenge.www.krovlya38.pro
   ``` 